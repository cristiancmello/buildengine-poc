
# AWS Journey First Steps

Objetivo: fornecer iniciação básica prática no AWS Management Console.

## 1. Criar o AWS IAM Group 'sandboxusers' e IAM User 'sandboxuser'

```
[AWS Management Console]
 -> [Fazer Login com uma conta do tipo User Root
   URL: https://console.aws.amazon.com/
 ]
 -> [Certificar-se de que AWS User Root esteja na região us-east-1 (N. Virginia)
   URL do Management Console em us-east-1: https://console.aws.amazon.com/console/home?nc2=h_ct&src=header-signin&region=us-east-1
 ]
 -> [Criar um Grupo de IAM Users pelo AWS IAM
   
   1. Acessar a URL: https://console.aws.amazon.com/iam/home?region=us-east-1#/groups
   2. Clique em "Create New Group" e dê o nome "sandboxusers"
   (Obs.: não attach nenhum tipo de policy)
   3. Faça a review e confirme a criação do group.
 ]
 -> [Criar IAM User pelo AWS IAM na região us-east-1
   
   1. Acessar a URL: https://console.aws.amazon.com/iam/home?region=us-east-1#/users$new?step=details
   2. Preencha o formulário com os seguintes dados e clique em Next:
      - User name: sandboxuser
      - Access type: 
        [CHECKED] Programming access 
        [CHECKED] AWS Management Console access
      - Console password: [SELECTED] Autogenerated password
      - Require password reset: [UNCHECKED]
   3. Em Add user to group, deixe marcado o grupo "sandboxusers" e clique em Next;
   4. Em Add Tags, adicione essa lista e clique em next:
      - Type: sandbox
      - Availability: instructor

      Descrição: IAM User 'sandboxuser' é para somente o instrutor configurar e utilizar.
      Somente o owner da conta de root da AWS pode manipulá-lo;
   5. Faça a review e confirme.
 ]
```

## 2. Fornecer Policy para que sandboxuser consiga conceder permissões para si

```
[AWS Management Console]
  -> (Avançado para AWS IAM Group) [Fazer Deny All mas permitir passagem de determinados Resources
    exclusivamente em N. Virginia. Precisa ser AWS IAM Root Account.

    1. Vá no grupo sandboxusers e adicione a seguinte inline policy chamando-a de AWSServicesDefaultGroupDenyAllWithExceptionsInNVirginia:
    {
      "Effect": "Deny",
      "NotAction": [
        "iam:*",
        "ecr:*",
        "cloudtrail:*"
      ],
      "Resource": [
        "*"
      ],
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": [
            "us-east-1"
          ]
        }
      }
    }
  ]
  -> (Avançado para AWS IAM Group) [Negar Ações a Recursos específicos criados em certas condições.

    Descrição: a negação de certas Actions em recursos específicos pode oferecer
    uma ajuda a proteger recursos particulares, como Imagens de containers salvas no ECR
    pelo Root Account para que AWS Iam Users possam utilizar para experimentar mas não
    para, por exemplo, excluir ou alterar.

    1. Vá no grupo sandboxusers e adicione a seguinte inline policy chamando-a de AWSResourcesDefaultGroupShield:
    {
      "Effect": "Allow",
      "Action": [
        "iam:GetUserPolicy"
      ],
      "Resource": [
        "arn:aws:iam::467742762527:user/sandboxuser*"
      ]
    }
  ]
  -> (Avançado para AWS IAM Group) [Conceder Permissões IAM para que usuário sandboxuser consiga
    dar permissões de menor nível para si. Precisa ser AWS IAM Root Account.

    Descrição: o objetivo aqui é permitir certa liberdade para que sandboxuser consiga colocar
    suas próprias permissões desde que não violem as do seu grupo.

    1. Vá no grupo sandboxusers e adicione a seguinte inline policy chamando-a de IAMDefaultGroupPolicies:
    {
      "Effect": "Allow",
      "Action": [
        "iam:GetUserPolicy"
      ],
      "Resource": [
        "arn:aws:iam::467742762527:user/sandboxuser*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "iam:ListUsers"
      ],
      "Resource": [
        "arn:aws:iam::467742762527:group/sandboxusers",
        "arn:aws:iam::467742762527:user/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "iam:ListGroups"
      ],
      "Resource": [
        "arn:aws:iam::467742762527:group/"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "iam:PutUserPolicy",
        "iam:GetGroup",
        "iam:GetUser",
        "iam:ListUserPolicies",
        "iam:ListAttachedUserPolicies",
        "iam:ListGroupsForUser",
        "iam:ListGroupPolicies",
        "iam:ListAttachedGroupPolicies",
        "iam:DeleteUserPolicy"
      ],
      "Resource": [
        "arn:aws:iam::467742762527:group/sandboxusers",
        "arn:aws:iam::467742762527:user/${aws:username}"
      ]
    }
  ]
  -> (Avançado para AWS IAM Group) [Conceder Permissões IAM para que usuário sandboxuser consiga
    Listar Policies. Precisa ser AWS IAM Root Account.

    1. Vá no grupo sandboxusers e adicione a seguinte nova inline policy, chamando-a de IAMDefaultGroupListPolicies:
    {
        "Version": "2012-10-17",
        "Statement": [
            {
            "Effect": "Allow",
            "Action": [
                "iam:ListPolicies"
            ],
            "Resource": "*"
            }
        ]
    }
  ]
  -> (Avançado para AWS IAM Group) [Conceder Permissões IAM para que usuário sandboxuser consiga
    Ver somente as specs das suas policies.

    1. Vá no grupo sandboxusers e adicione a seguinte nova inline policy, chamando-a de IAMDefaultGroupGetUserPolicy:
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "iam:GetUserPolicy"
          ],
          "Resource": [
            "arn:aws:iam::467742762527:user/sandboxuser"
          ]
        }
      ]
    }
  ]
  ->(Avançado para AWS IAM Group) [Negar Operações no ECR para Resources não criados por um usuário do grupo sandboxusers
    Descrição: Essas permissões geram proteção para que ninguém diferente do autor que criou os resources
    exclua ou que façam criação de resources em nome dele no contexto do ECR.

    1. Vá no grupo sandboxusers e adicione a seguinte nova inline policy, chamando-a de ECRDenyECRForNonOwnersPolicy:
    {
      "Effect": "Deny",
      "Action": [
        "ecr:CreateRepository",
        "ecr:DeleteRepository"
      ],
      "NotResource": [
        "arn:aws:ecr:*:*:repository/${aws:username}*"
      ]
    }
  -> (Avançado para AWS IAM Group) [Permitir com que todos os users do grupo sandboxusers consiga listar repositórios criados no ECR.

    1. Vá no grupo sandboxusers e adicione a seguinte nova inline policy, chamando-a de ECRAllowDescribeRepositoriesPolicy:
    {
      "Effect": "Allow",
      "Action": [
        "ecr:DescribeRepositories"
      ],
      "Resource": [
        "*"
      ]
    }
  ]
  -> (Avançado para AWS IAM Group *CENTRALIZAÇÃO*) [Estabelecer Permissões e Negar Acessos ao grupo sandboxusers
    
    Descrição: as permissões e negações anteriores foram classificadas de acordo
    com restrições lógicas e para facilitar o entendimento. Poderíamos sintetizar
    todas as permissões num único Policy a ser anexado ao sandboxusers.

    1. Vá no grupo sandboxusers e adicione a seguinte nova inline policy, chamando-a de SandboxusersDefaultPolicies:
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Deny",
          "NotAction": [
            "iam:*",
            "ecr:*",
            "cloudtrail:*"
          ],
          "Resource": [
            "*"
          ],
          "Condition": {
            "StringEquals": {
              "aws:RequestedRegion": [
                "us-east-1"
              ]
            }
          }
        },
        {
          "Effect": "Allow",
          "Action": [
            "iam:GetUserPolicy"
          ],
          "Resource": [
            "arn:aws:iam::467742762527:user/sandboxuser*"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "iam:ListPolicies"
          ],
          "Resource": "*"
        },
        {
          "Effect": "Allow",
          "Action": [
            "iam:ListUsers"
          ],
          "Resource": [
            "arn:aws:iam::467742762527:group/sandboxusers",
            "arn:aws:iam::467742762527:user/*"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "iam:ListGroups"
          ],
          "Resource": [
            "arn:aws:iam::467742762527:group/"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "iam:PutUserPolicy",
            "iam:GetGroup",
            "iam:GetUser",
            "iam:ListUserPolicies",
            "iam:ListAttachedUserPolicies",
            "iam:ListGroupsForUser",
            "iam:ListGroupPolicies",
            "iam:ListAttachedGroupPolicies",
            "iam:DeleteUserPolicy"
          ],
          "Resource": [
            "arn:aws:iam::467742762527:group/sandboxusers",
            "arn:aws:iam::467742762527:user/${aws:username}"
          ]
        },
        {
          "Effect": "Deny",
          "Action": [
            "ecr:CreateRepository",
            "ecr:DeleteRepository"
          ],
          "NotResource": [
            "arn:aws:ecr:*:*:repository/${aws:username}*"
          ]
        },
        {
          "Effect": "Allow",
          "Action": [
            "ecr:DescribeRepositories"
          ],
          "Resource": [
            "*"
          ]
        }
      ]
    }
  -> (Avançado para AWS ECR Repository Policies) [Negar Ações para usuários diferente do owner que criou
  o repository.

  Descrição: este caso em especial é útil como alternativa de isolamento dos recursos, como repository,
  criado um por sandboxuser do grupo sandboxusers. Isso evita exclusões de repositórios, a exemplo, 
  realizado outros usuários do grupo. Entretanto, o AWS Management Console não suporta essa config, terá
  que fazer pelo AWSCLI.

  1. Pelo AWSCLI, execute o comando ecr-set-repository-policies.bat para configurar as ecr policies;
  2. Pelo AWSCLI, execute o comando ecr-get-repository-policies.bat para obter as ecr policies atuais.

  Obs.: O arquivo ECRComplexPolicies.json contém as policies com "Principal", o que o AWS Management Console
  não suporta configurar.
  ]
```

## CONCLUSÃO

* Temos 2 Resources:
 - AWS IAM Group: sandboxusers
 - AWS IAM User: sandboxuser

* Qual o propósito de sandboxusers?
É um grupo para facilitar o controle de usuários que estão
aprendendo e testando recursos da AWS num ambiente seguro e controlado.

* Qual o propósito de sandboxuser?
É um usuário do tipo Instrutor, existe apenas 1 usuário desse tipo
não podendo ser compartilhado com nenhum outro.

* Qual é o maior objetivo com essa organização de sandboxusers?
Possibilitar controle de permissões globais quando tivermos novos
usuários que queiram aprender sobre AWS num ambiente controlado e seguro.
Gostaríamos de fornecer certas liberdades para o sandboxuser conseguir
fazer coisas como adicionar policies extras para experimentar
novos recursos.

* Se existe apenas o usuario sandboxuser para fins do Instrutor, como serão
os novos? Para qual grupo irão pertencer?
Novos usuários serão semelhantes a sandboxuser, podendo haver mudança
de nome para um padrão do tipo "sandboxuser-1, sandboxuser-2, ...".
Irão pertencer ao grupo sandboxusers.